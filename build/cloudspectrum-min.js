var _uuid=0;function CloudSpectrum(b){this.cfg=this.merge({node:"",width:600,height:400,mode:"edit"},b);this.cache={};this._init()}
CloudSpectrum.prototype={constructor:CloudSpectrum,_init:function(){var b=this,d=b.cfg,a=b.dom(),c=d.width,e=d.height;node=a.get(d.node);node.width(c);node.height(e);d="cloudSpectrum-"+b._guid();node.html('<div id="'+d+'" class="ui-cloudSpectrum"></div>');b.paper=Raphael(d,c,e);b.paper.rect(0,0,c,e,10).attr({stroke:"#666"});Raphael.fn.connection=function(a,c,d){var e;a.line&&(a.from&&a.to)&&(e=a,a=e.from,c=e.to);var f=a.getBBox(),h=c.getBBox(),g=[{x:f.x+f.width/2,y:f.y+f.height/2},{x:h.x+h.width/
2,y:h.y+h.height/2},{x:h.x+h.width/2,y:h.y+h.height/2}],f=(g[1].x+g[0].x)/2,h=(g[1].y+g[0].y)/2,g=["M",g[0].x,g[0].y,"L",g[1].x,g[1].y].join();if(e&&e.line)e.line.toBack().attr({path:g}),e.lineNode.attr({x:f,y:h,cx:f,cy:h});else return{line:this.path(g).toBack().attr({stroke:"#C6D9EC","stroke-width":"2px",fill:"none"}),from:a,to:c,lineNode:b.paper.set().push(this.circle(f,h,8).attr({fill:"#BED8EC",stroke:"#C6D9EC"}),this.text(f,h,"?").attr({stroke:"#fff",cursor:"pointer"})),lineOpt:d}}},render:function(b){var d,
a;function c(){if(this.data("setIndex")&&void 0!=this.data("dataIndex")){A=p[this.data("setIndex")];B=x[this.data("dataIndex")];var r=A.getBBox();a=d=void 0;y=!0;d=r.x+r.width/2;a=r.y+r.height/2}}function e(r,c){if(y){var l=d+r,b=a+c,e={x:l,y:b,cx:l,cy:b};C||(A.attr(e),B.theta=Raphael.rad(Raphael.angle(l,b,m.w/2,m.h/2)),B.radius=f._computeLength(m.w/2,m.h/2,l,b),C=!0,setTimeout(function(){C=!1},40));for(l=u.length;l--;)g.connection(u[l]);g.safari()}}function G(){y&&(y=!1)}function n(a,b,l){l=s[a.id];
if(0<b.length)for(var c=0;c<b.length;c++)if(b[c]){var e=b[c],f=e.id;u.push(g.connection(p[l.index],p[s[f].index],{pid:a.id,id:f}));n(e,e.childNodes)}}function w(a,b){if(b.length){var c=b.length;f._getAverageWeight(b);if(void 0!==a.theta){var e=Math.PI/c;2==t&&(e=Math.PI/10);3==t&&e>Math.PI/24&&(e=Math.PI/24);for(var d=e*(c-1)/2-a.theta,g=0;g<c;g++)E(b[g],a,3.5*t*v,-d+g*e)}else for(e=2*Math.PI/c,g=0;g<c;g++)E(b[g],a,3.5*t*v,g*e)}}function E(a,b,c,e){if(!s[a.id]){var d=x.length,k=f.shapes.length;b=
"edit"==h.mode?f._polarToXY(b,c,e):f._polarToXY(b,a.radius,a.theta);p.push(g.set().push(g.circle(b[0],b[1],v).attr(H).data("setIndex",k),g.text(b[0],b[1],a.name).attr(F).data("setIndex",k).data("dataIndex",d)));s[a.id]={x:b[0],y:b[1],theta:e,index:k};a.theta=e;a.radius=c;x.push(a)}}var f=this,h=f.cfg,g=f.paper;f.connections=[];f.shapes=[];f.flatData=[];f.cache={};f.cache.w=h.width;f.cache.h=h.height;f.objects={};var p=f.shapes,m=f.cache,s=f.objects,x=f.flatData,I={fill:"#5782C2",stroke:"#5782C2"},
H={fill:"#97C2EE",stroke:"#97C2EE"},F={fill:"#fff","font-size":"14px","font-weight":"400"},k=Math.round(Math.max(m.w,m.h)/6),v=Math.round(k/4);f.circleRadius=v;var k=[],q=[],t=1;k.push(b);(function(a){for(var b=0;0<a.length;){var c=a.shift();if(c)if(0==c.parent){var e=m.w/2,d=m.h/2,h=f.shapes.length;p.push(g.set().push(g.circle(e,d,1.2*v).attr(I).data("setIndex",h),g.text(e,d,c.name).attr(F).data("setIndex",h)));s[c.id]={x:e,y:d,theta:0,index:0};c.theta=0;c.radius=0;x.push(c);0<c.childNodes.length&&
q.push(c.childNodes.length);w({x:e,y:d},c.childNodes);a=a.concat(c.childNodes);t++}else e=s[c.id],b==q[0]?(q.shift(),b=0,t++,q.push(c.childNodes.length)):q[1]=q[1]?q[1]+c.childNodes.length:c.childNodes.length,w(e,c.childNodes),a=a.concat(c.childNodes),b++}})(k);for(var y=!1,A,B,C=!1,k=0,D=p.length;k<D;k++){Raphael.getColor();var z=p[k];z.attr({cursor:"pointer"});"edit"==h.mode&&(z.attr({cursor:"move"}),z.drag(e,c,G));(function(a){a.mouseover(function(){a.stop().animate({transform:"s1.2 1.2"},500,
"backOut")}).mouseout(function(){a.stop().animate({transform:""},500,"backOut")})})(z)}var u=[];n(b,b.childNodes);k=0;for(D=u.length;k<D;k++)b=u[k],function(a,c){a&&(a.mouseover(function(){a.stop().animate({transform:"s1.2 1.2"},500,"backOut")}).mouseout(function(){a.stop().animate({transform:""},500,"backOut")}),a.click(function(a){var c=document.getElementById("messagePanel");c.style.display="block";c.style.left=a.x+30+"px";c.style.top=a.y-25+"px"}))}(b.lineNode,b.lineOpt)},save:function(){return this.flatData},
_guid:function(){return++_uuid},_polarToXY:function(b,d,a){b=this.cache;var c=b.h/2;return[b.w/2+d*Math.cos(a),c+d*Math.sin(a)]},_computeLength:function(b,d,a,c){return Math.sqrt((b-a)*(b-a)+(d-c)*(d-c))},_getAverageWeight:function(b){if(!b.length)return 0;for(var d=0,a=0,c=b.length;a<c;a++)d+=b[a].weight;return d/b.length},merge:function(b,d){return d},dom:function(){function b(){this.elements=[];this.handlers={}}function d(){this.handlers={}}b.prototype={constructor:b,get:function(a,c){var b;if("string"==
typeof a)if(b=a,"#"==b.slice(0,1))b=document.getElementById(b.slice(1)),this.elements.push(b);else if(document.querySelectorAll)this.elements.concat(document.querySelectorAll(b,c.elements));else for(var d=document.body.getElementsByTagName("*"),n=0,w=d.length;n<w;n++)-1!=b.indexOf(d[n].className)&&this.elements.push(d[n]);else this.elements.push(this);return this},each:function(a){for(var c=0,b=this.elements.length;c<b;c++)a.call(this,this.elements[c],c);return this},css:function(a,b){if(b)this.each(function(e){e.style[a]=
b});else return this.elements[0].style[a]},width:function(a){return a?(this.elements[0].style.width=a,this):this.elements[0].offsetWidth},height:function(a){return a?(this.elements[0].style.height=a,this):this.elements[0].offsetHeight},html:function(a){this.elements[0].innerHTML=a}};d.prototype={constructor:d,on:function(a,b){this.handlers[a]=[]},fire:function(){event.target||(event.target=this);if(this.handlers[event.type instanceof Array])for(var a=this.handlers[event.type],b=0,e=a.length;b<e;b++)a[b](event)},
removeHandler:function(a,b){if(this.handlers[a]instanceof Array)for(var e=this.handlers[a],d=0;d<len&&e[d]!==b;d++)e.splice(d,1)}};return new b}};
